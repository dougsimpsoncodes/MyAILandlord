name: PR Stability Checklist

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

permissions:
  contents: read
  pull-requests: read

jobs:
  checklist:
    name: Checklist Gate
    runs-on: ubuntu-latest
    steps:
      - name: Validate checklist confirmations
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100,
            });

            const docOnly = files.every(({ filename }) => {
              return (
                filename.startsWith('docs/') ||
                filename.startsWith('.github/') ||
                filename === 'README.md' ||
                filename === 'AGENTS.md' ||
                filename === 'LICENSE'
              );
            });

            if (docOnly) {
              core.info('Docs/metadata-only PR detected. Checklist gate skipped.');
              return;
            }

            const required = [
              'STABILITY_GATE_TYPECHECK',
              'STABILITY_GATE_UNIT',
              'STABILITY_GATE_ROLLOUT',
              'STABILITY_GATE_ROLLBACK',
            ];

            const missing = [];
            for (const token of required) {
              const checked = new RegExp(`- \\[x\\] ${token}\\b`, 'i').test(body);
              if (!checked) {
                missing.push(token);
              }
            }

            const hasRls = /- \[x\] STABILITY_GATE_RLS\b/i.test(body) || /- \[x\] STABILITY_GATE_RLS_NA\b/i.test(body);
            if (!hasRls) {
              missing.push('STABILITY_GATE_RLS or STABILITY_GATE_RLS_NA');
            }

            const hasDeviceSmoke = /- \[x\] STABILITY_GATE_DEVICE_SMOKE\b/i.test(body) || /- \[x\] STABILITY_GATE_DEVICE_SMOKE_NA\b/i.test(body);
            if (!hasDeviceSmoke) {
              missing.push('STABILITY_GATE_DEVICE_SMOKE or STABILITY_GATE_DEVICE_SMOKE_NA');
            }

            if (missing.length > 0) {
              core.setFailed(`Missing checklist confirmations: ${missing.join(', ')}`);
            } else {
              core.info('All required stability checklist confirmations are present.');
            }
